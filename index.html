<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance Dashboard</title>
<style>
  :root { --bg:#0f172a; --card:rgba(30, 41, 59, 0.7); --text:#f1f5f9; --accent:#3b82f6; --border:rgba(255,255,255,0.1); }
  body { margin:0; font-family:system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
  header { background:rgba(15, 23, 42, 0.95); padding:15px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:50; backdrop-filter:blur(10px); }
  button { cursor:pointer; border-radius:6px; border:none; padding:8px 14px; font-weight:600; transition:0.2s; }
  button:hover { opacity:0.9; transform:translateY(-1px); }
  .container { max-width:1200px; margin:20px auto; padding:0 15px; display:flex; gap:20px; flex-wrap:wrap; }
  .main { flex:3; min-width:300px; }
  .sidebar { flex:1; min-width:280px; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
  h2, h3 { margin-top:0; color:var(--accent); }
  .stat-row { margin-bottom:15px; }
  .stat-head { display:flex; justify-content:space-between; font-size:14px; margin-bottom:6px; font-weight:500; }
  .progress-bg { background:rgba(255,255,255,0.1); height:10px; border-radius:5px; overflow:hidden; }
  .progress-fill { height:100%; transition:width 0.5s ease; border-radius:5px; }
  .p-green { background:#22c55e; } .p-orange { background:#f59e0b; } .p-red { background:#ef4444; }
  .week-row { display:flex; border-bottom:1px solid var(--border); padding:12px 0; align-items:center; }
  .week-row:last-child { border-bottom:none; }
  .week-day { width:100px; font-weight:bold; color:#94a3b8; font-size:14px; }
  .week-subjects { flex:1; display:flex; flex-wrap:wrap; gap:8px; }
  .sub-tag { background:#334155; padding:4px 10px; border-radius:15px; font-size:12px; border:1px solid var(--border); }
  .sub-tag.long { border-color:#3b82f6; color:#bfdbfe; }
  .subject-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px; margin-top:15px; }
  .sub-btn { background:#334155; color:white; padding:15px; border:1px solid var(--border); border-radius:10px; display:flex; flex-direction:column; gap:8px; min-height:90px; transition:0.2s; position:relative; overflow:hidden; }
  .sub-btn:hover { background:#475569; border-color:#64748b; }
  .sub-btn.long { grid-column: span 2; background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border:1px solid #3b82f6; }
  .sub-btn.long::after { content:"2 HR"; position:absolute; top:5px; right:35px; font-size:10px; background:#3b82f6; padding:2px 6px; border-radius:4px; font-weight:bold; }
  .card-top { display:flex; justify-content:space-between; align-items:start; width:100%; }
  .reorder-controls { display:flex; gap:2px; }
  .move-btn { background:rgba(0,0,0,0.3); color:#94a3b8; padding:2px 6px; font-size:10px; border:1px solid var(--border); border-radius:4px; cursor:pointer; height:fit-content; }
  .move-btn:hover { background:white; color:black; }
  .actions { display:flex; gap:4px; margin-top:auto; }
  .act-btn { flex:1; padding:6px; font-size:11px; border-radius:4px; border:none; color:white; font-weight:bold; }
  .bg-green { background:#16a34a; } .bg-red { background:#dc2626; } .bg-orange { background:#ea580c; } .bg-blue { background:#2563eb; } .bg-purple { background:#9333ea; }
  .editor-box { background:#1e293b; padding:15px; border-radius:8px; border:1px solid var(--border); margin-bottom:20px; }
  .hidden { display:none; }
  .reschedule-box { background:rgba(147, 51, 234, 0.1); border:1px solid rgba(147, 51, 234, 0.3); padding:10px; border-radius:6px; margin-top:10px; }
  label { display:block; font-size:12px; color:#94a3b8; margin:10px 0 4px; }
  input, select { width:100%; padding:10px; background:#020617; border:1px solid #334155; color:white; border-radius:6px; box-sizing:border-box; }
  .btn-full { width:100%; margin-top:10px; padding:12px; font-size:14px; cursor:pointer; border:none; border-radius:6px; }
  .btn-full:active { transform:scale(0.98); }
  .logout { background:#ef4444; color:white; }
  #toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:white; color:black; padding:12px 24px; border-radius:50px; font-weight:600; display:none; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
</style>
</head>
<body>
<script>window.onerror = function(msg, url, line) { alert("Code Error: " + msg + "\nLine: " + line); };</script>
<header>
  <div><strong>Attendance</strong> <span id="userDisp" style="font-size:12px; color:#94a3b8; margin-left:5px;"></span></div>
  <div>
    <button onclick="toggleEditor()" style="background:#3b82f6; color:white; margin-right:10px;">âœŽ Edit Schedule</button>
    <button class="logout" onclick="logout()">Log Out</button>
  </div>
</header>
<div class="container">
  <div class="main">
    <div class="card">
      <h3>Attendance Statistics</h3>
      <p style="font-size:12px; color:#94a3b8; margin-bottom:15px;">Weighted: 1hr = 1pt, 2hr = 2pts.</p>
      <div id="statsContainer"><div style="text-align:center; padding:10px; color:#64748b;">Loading stats...</div></div>
    </div>
    <div id="editor" class="card hidden">
      <h3>Manage Subjects</h3>
      <div class="editor-box">
        <label>Day</label><select id="edDay"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option></select>
        <label>Subject</label><input id="edName" placeholder="e.g. NAS">
        <label>Duration</label><select id="edDur"><option value="1">1 Hour</option><option value="2">2 Hours</option></select>
        <button class="btn-full" onclick="addSubject()" style="background:#16a34a; color:white;">+ Add to Schedule</button>
      </div>
      <button onclick="clearSchedule()" style="color:#ef4444; background:none; border:1px solid #ef4444; width:auto; padding:5px;">Reset Data</button>
    </div>
    <div class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <h2 id="dayHeader" style="margin:0;">Today</h2>
        <span style="font-size:12px; color:#94a3b8" id="dateDisp"></span>
      </div>
      <div id="subjectList" class="subject-grid"></div>
      <div id="emptyMsg" style="text-align:center; padding:40px; display:none; color:#94a3b8">No classes today.</div>
    </div>
    <div class="card"><h3>Weekly Schedule</h3><div id="weeklyContainer"></div></div>
  </div>
  <div class="sidebar">
    <div class="card">
      <h3>Manual Entry</h3>
      <label>Date</label><input type="date" id="mDate">
      <label>Day</label><select id="mDay"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option></select>
      <label>Subject</label><input id="mSubject" list="mySubjects" placeholder="Select Subject"><datalist id="mySubjects"></datalist>
      <label>Duration</label><select id="mWeight"><option value="1">1 Hour</option><option value="2">2 Hours</option></select>
      <label>Status</label><select id="mStatus" onchange="toggleRescheduleBox()"><option>Attended</option><option>Bunked</option><option>Absent</option><option>Cancelled by Teacher</option><option>Cancelled by CR</option><option>Rescheduled</option></select>
      <div id="rescheduleBox" class="reschedule-box hidden">
        <label style="color:#e879f9">New Date</label><input type="date" id="rDate">
        <label style="color:#e879f9">New Time</label><input type="time" id="rTime">
      </div>
      <label>Remark (Optional)</label><input id="mRemark" placeholder="e.g. Extra class">
      <button class="btn-full" onclick="manual()" style="background:#3b82f6; color:white;">Add Entry</button>
      <div style="margin:20px 0; border-top:1px solid var(--border);"></div>
      <button class="btn-full" onclick="exportMyData()" style="background:#16a34a; color:white;">ðŸ“¥ Download Attendance Logs</button>
    </div>
  </div>
</div>
<div id="toast">Saved!</div>

<script>
// =================================================================
// PASTE YOUR SCRIPT URL HERE
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzdqbNdHgOweAyZhCcSYiEBlnGmWiFj_xbkyIBwrxp5MyDyWTLb-kIZxcZO9wpu6FtsXQ/exec";
// =================================================================

const user = localStorage.getItem("userName");
const roll = localStorage.getItem("userRoll");
if(!user || !roll) window.location.href="login.html";

document.getElementById("userDisp").innerText = user;
document.getElementById("dateDisp").innerText = new Date().toLocaleDateString();

let mySchedule = JSON.parse(localStorage.getItem("mySchedule")) || { Monday:[], Tuesday:[], Wednesday:[], Thursday:[], Friday:[] };
const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
const today = days[new Date().getDay()];
document.getElementById("dayHeader").innerText = today;

init();

function init() {
  updateSubjectList();
  renderSchedule();
  renderWeekly();
  fetchStats();
}

/* === SYNC SCHEDULE TO SERVER (NEW) === */
function syncSchedule() {
  // Fire and forget (don't block UI)
  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      type: "save-schedule",
      roll: roll,
      schedule: JSON.stringify(mySchedule)
    })
  }).then(r => console.log("Schedule synced"));
}

/* === SEND ATTENDANCE === */
async function sendData(day, subject, status, remark, weight, dateOverride) {
  const toast = document.getElementById("toast");
  toast.innerText = "Saving..."; toast.style.display = "block"; toast.style.background = "white"; toast.style.color = "black";
  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        name: user, roll: roll,
        date: dateOverride ? new Date(dateOverride).toLocaleDateString() : new Date().toLocaleDateString(),
        day: day, subject: subject, status: status, remark: remark, weight: parseInt(weight)
      })
    });
    const data = await res.json();
    if(data.status === "success") {
      toast.innerText = "Saved successfully!";
      await fetchStats(); 
      setTimeout(() => toast.style.display="none", 2000);
    } else throw new Error(data.message || "Unknown error");
  } catch(e) {
    toast.innerText = "Error: Not Saved"; toast.style.background = "#ef4444"; toast.style.color = "white"; setTimeout(() => toast.style.display="none", 3000);
  }
}

function toggleRescheduleBox() {
  const status = document.getElementById("mStatus").value;
  document.getElementById("rescheduleBox").classList.toggle("hidden", status !== "Rescheduled");
}

/* === RENDER FUNCTIONS === */
function renderSchedule() {
  const container = document.getElementById("subjectList");
  container.innerHTML = "";
  const subjects = mySchedule[today] || [];
  if(subjects.length === 0) {
    document.getElementById("emptyMsg").style.display = "block";
  } else {
    document.getElementById("emptyMsg").style.display = "none";
    subjects.forEach((sub, index) => {
      const isLong = sub.duration == 2;
      const cls = isLong ? "sub-btn long" : "sub-btn";
      const showUp = index > 0 ? `<button class="move-btn" onclick="moveSubject(${index}, -1)">â–²</button>` : '';
      const showDown = index < subjects.length - 1 ? `<button class="move-btn" onclick="moveSubject(${index}, 1)">â–¼</button>` : '';
      const html = `
        <div class="${cls}">
          <div class="card-top"><div style="font-weight:bold; font-size:15px;">${sub.name}</div><div class="reorder-controls">${showUp}${showDown}</div></div>
          <div class="actions">
            <button class="act-btn bg-green" onclick="mark('${sub.name}', 'Attended', ${sub.duration})">P</button>
            <button class="act-btn bg-red" onclick="mark('${sub.name}', 'Bunked', ${sub.duration})">B</button>
            <button class="act-btn bg-orange" onclick="mark('${sub.name}', 'Absent', ${sub.duration})">A</button>
            <button class="act-btn bg-blue" onclick="mark('${sub.name}', 'Cancelled', 0)">C</button>
            <button class="act-btn bg-purple" onclick="mark('${sub.name}', 'Rescheduled', ${sub.duration}, 'Rescheduled')">R</button>
          </div>
        </div>`;
      container.innerHTML += html;
    });
  }
}

function renderWeekly() {
  const container = document.getElementById("weeklyContainer");
  container.innerHTML = "";
  const weekDays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
  weekDays.forEach(day => {
    const subjects = mySchedule[day] || [];
    let subHtml = subjects.length === 0 
      ? `<span style="font-size:12px; color:#64748b; font-style:italic;">No classes</span>` 
      : subjects.map(s => `<span class="${s.duration==2?'sub-tag long':'sub-tag'}">${s.name}</span>`).join("");
    container.innerHTML += `<div class="week-row"><div class="week-day">${day}</div><div class="week-subjects">${subHtml}</div></div>`;
  });
}

async function fetchStats() {
  try {
    const res = await fetch(`${SCRIPT_URL}?type=history&roll=${encodeURIComponent(roll)}`);
    const history = await res.json();
    const stats = {};
    history.forEach(entry => {
      const sub = entry.subject; const weight = parseInt(entry.weight) || 1;
      if (!stats[sub]) stats[sub] = { attended: 0, total: 0 };
      if (entry.status === "Attended") { stats[sub].attended += weight; stats[sub].total += weight; }
      else if (entry.status === "Absent" || entry.status === "Bunked") { stats[sub].total += weight; }
    });
    renderStats(stats);
  } catch (e) { document.getElementById("statsContainer").innerHTML = '<div style="text-align:center;font-size:12px;color:#ef4444">Failed to load stats</div>'; }
}

function renderStats(stats) {
  const container = document.getElementById("statsContainer");
  container.innerHTML = "";
  if (Object.keys(stats).length === 0) { container.innerHTML = '<div style="text-align:center;font-size:12px;color:#64748b">No data yet</div>'; return; }
  for (const [sub, data] of Object.entries(stats)) {
    if (data.total === 0) continue;
    const pct = Math.round((data.attended / data.total) * 100);
    let color = pct >= 75 ? "p-green" : (pct >= 50 ? "p-orange" : "p-red");
    container.innerHTML += `<div class="stat-row"><div class="stat-head"><span>${sub}</span><span>${pct}% <span style="opacity:0.5;font-size:11px;">(${data.attended}/${data.total}) pts</span></span></div><div class="progress-bg"><div class="progress-fill ${color}" style="width:${pct}%"></div></div></div>`;
  }
}

function updateSubjectList() {
  const set = new Set();
  Object.values(mySchedule).forEach(arr => arr.forEach(s => set.add(s.name)));
  const datalist = document.getElementById("mySubjects");
  datalist.innerHTML = "";
  set.forEach(name => { const opt = document.createElement("option"); opt.value = name; datalist.appendChild(opt); });
}

function moveSubject(index, direction) {
  const dayList = mySchedule[today];
  if (!dayList) return;
  [dayList[index], dayList[index + direction]] = [dayList[index + direction], dayList[index]];
  localStorage.setItem("mySchedule", JSON.stringify(mySchedule));
  syncSchedule(); // SYNC ON MOVE
  renderSchedule(); renderWeekly();
}

function toggleEditor() { document.getElementById("editor").classList.toggle("hidden"); }

function addSubject() {
  const day = document.getElementById("edDay").value;
  const name = document.getElementById("edName").value.trim();
  const dur = document.getElementById("edDur").value;
  if(!name) return alert("Enter subject name");
  mySchedule[day].push({ name: name, duration: parseInt(dur) });
  localStorage.setItem("mySchedule", JSON.stringify(mySchedule));
  syncSchedule(); // SYNC ON ADD
  updateSubjectList(); renderWeekly();
  if(day === today) renderSchedule();
  alert("Added!");
}

function clearSchedule() {
  if(confirm("Delete all subjects?")) { 
    localStorage.removeItem("mySchedule");
    mySchedule = { Monday:[], Tuesday:[], Wednesday:[], Thursday:[], Friday:[] };
    syncSchedule(); // SYNC ON CLEAR
    location.reload(); 
  }
}

function mark(subject, status, weight, remark="") { sendData(today, subject, status, remark, weight); }

function manual() {
  const d = document.getElementById("mDate").value; if(!d) return alert("Select date");
  const sub = document.getElementById("mSubject").value; if(!sub) return alert("Enter subject");
  const weight = document.getElementById("mWeight").value;
  const status = document.getElementById("mStatus").value;
  let rem = document.getElementById("mRemark").value;
  if(status === "Rescheduled") {
    const rDate = document.getElementById("rDate").value;
    const rTime = document.getElementById("rTime").value;
    if(rDate) rem += ` (To: ${rDate} ${rTime})`;
  }
  const btn = document.querySelector(".sidebar .btn-full"); const oldText = btn.innerText; btn.innerText = "Processing..."; btn.disabled = true;
  sendData(document.getElementById("mDay").value, sub, status, rem, weight, d).then(() => { btn.innerText = oldText; btn.disabled = false; document.getElementById("mSubject").value = ""; document.getElementById("mRemark").value = ""; });
}

function exportMyData() { window.open(`${SCRIPT_URL}?roll=${encodeURIComponent(roll)}`, "_blank"); }
function logout() { if(confirm("Log out?")) { localStorage.clear(); window.location.href = "login.html"; } }
</script>
</body>
</html>